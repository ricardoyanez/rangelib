/*
  Author: Ricardo Yanez
  Copyright (c) 2005-2023 Ricardo Yanez <ricardo.yanez@calel.org>

  Calculates energy loss of an ion in an absorber by constructing
  range tables based on either the,

  Northcliffe-Schilling correlations  (E/A < 12 MeV/A)
  (L.C. Northcliffe, R.F. Schilling, Nucl. Data Tables A7, 233, 1970).

  or,

  Hubert-Bimbot-Gauvin correlations (2.5 < E/A < 100 MeV/A)
  (Atomic Data and Nuclear Data Tables, 1990, 46, pp. 1-213).

  License:

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA

*/

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <stdbool.h>

#ifndef _NMAX
#define _NMAX
# define NMAX 4000
#endif

#define NSAV 20000

#include "range.h"
#include "nr.h"

#ifdef __cplusplus
extern "C" {
#endif

struct elem cmpnd[NELMAX];
int numel;

bool isw1 = false;
bool isw2 = false;
bool isw3 = false;
bool isw4 = false;
bool isw5 = false;

/*
  Define the absorber given iabso. If iabso = -1, the absorber is 
  user defined. If iabso = 0, the absorber is a single element. If
  iabso > 0, the abosorber is pre-defined.
*/
void def_absorber(int zt, int at, int iabso) {

  switch(iabso) {

  // User defined
  case -1:
    for ( int i = 0 ; i < nelem ; i++ ) {
      cmpnd[i].z = absorb[i].z;
      cmpnd[i].a = absorb[i].a;
      cmpnd[i].w = absorb[i].w;
    }
    numel = nelem;
    break;

  // Single element
  case 0:
    numel = 1;
    cmpnd[0].z = zt;
    cmpnd[0].a = at;
    cmpnd[0].w = at*1.0;
    break;

  // Solids

  case 1:       // Mylar (C-10, H-8, O-4)
    numel = 3;
    cmpnd[0].z = 6; cmpnd[0].a = 12; cmpnd[0].w = cmpnd[0].a*10.0;
    cmpnd[1].z = 1; cmpnd[1].a = 1;  cmpnd[1].w = cmpnd[1].a*8.0;
    cmpnd[2].z = 8; cmpnd[2].a = 16; cmpnd[2].w = cmpnd[2].a*4.0;
    break;

  case 2:       // Polyethylene (C-2, H-4)
    numel = 2;
    cmpnd[0].z = 6; cmpnd[0].a = 12; cmpnd[0].w = cmpnd[0].a*2.0;
    cmpnd[1].z = 1; cmpnd[1].a = 1;  cmpnd[1].w = cmpnd[1].a*4.0;
    break;

  case 3:       // Polypropylene (C-3, H-6)
    numel = 2;
    cmpnd[0].z = 6; cmpnd[0].a = 12; cmpnd[0].w = cmpnd[0].a*3.0;
    cmpnd[1].z = 1; cmpnd[1].a = 1;  cmpnd[1].w = cmpnd[1].a*6.0;
    break;

  case 4:       // Kapton (H-10, C-22, N-2, O-5)
    numel = 4;
    cmpnd[0].z = 1; cmpnd[0].a = 1;  cmpnd[0].w = cmpnd[0].a*10.0;
    cmpnd[1].z = 6; cmpnd[1].a = 12; cmpnd[1].w = cmpnd[1].a*22.0;
    cmpnd[2].z = 7; cmpnd[2].a = 14; cmpnd[2].w = cmpnd[2].a*2.0;
    cmpnd[3].z = 8; cmpnd[3].a = 16; cmpnd[3].w = cmpnd[3].a*5.0;
    break;

  case 5:       // Cesium Iodine (CsI)
    numel = 2;
    cmpnd[0].z = 55; cmpnd[0].a = 133; cmpnd[0].w = cmpnd[0].a*1.0;
    cmpnd[1].z = 53; cmpnd[1].a = 127; cmpnd[1].w = cmpnd[1].a*1.0;
    break;

  case 6:       // Sodium Iodine (NaI)
    numel = 2;
    cmpnd[0].z = 11; cmpnd[0].a = 23;  cmpnd[0].w = cmpnd[0].a*1.0;
    cmpnd[1].z = 53; cmpnd[1].a = 127; cmpnd[1].w = cmpnd[1].a*1.0;
    break;

  case 7:       // Aluminum Oxide (Al2O3)
    numel = 2;
    cmpnd[0].z = 13; cmpnd[0].a = 27; cmpnd[0].w = cmpnd[0].a*2.0;
    cmpnd[1].z = 8;  cmpnd[1].a = 16; cmpnd[1].w = cmpnd[1].a*3.0;
    break;

  case 8:       // Tin-Lead (Sn60/Pb40)
    numel = 4;
    cmpnd[0].z = 50; cmpnd[0].a = 116; cmpnd[0].w = 0.206*60.0;
    cmpnd[1].z = 50; cmpnd[1].a = 118; cmpnd[1].w = 0.340*60.0;
    cmpnd[2].z = 50; cmpnd[2].a = 120; cmpnd[2].w = 0.454*60.0;
    cmpnd[3].z = 82; cmpnd[3].a = 208; cmpnd[3].w = 40.0;
    break;

  case 9:       // Natural Ni (Ni-nat)
    numel = 5;
    cmpnd[0].z = 28; cmpnd[0].a = 58; cmpnd[0].w = cmpnd[0].a*0.680769;
    cmpnd[1].z = 28; cmpnd[1].a = 60; cmpnd[1].w = cmpnd[1].a*0.262231;
    cmpnd[2].z = 28; cmpnd[2].a = 61; cmpnd[2].w = cmpnd[2].a*0.011399;
    cmpnd[3].z = 28; cmpnd[3].a = 62; cmpnd[3].w = cmpnd[3].a*0.036345;
    cmpnd[4].z = 28; cmpnd[4].a = 64; cmpnd[4].w = cmpnd[4].a*0.009256;
    break;

  case 10:      // Uranium Tetrafluoride (UF4)
    numel = 2;
    cmpnd[0].z = 92; cmpnd[0].a = 238; cmpnd[0].w = cmpnd[0].a*1.0;
    cmpnd[1].z = 9; cmpnd[1].a = 19; cmpnd[1].w = cmpnd[1].a*4.0;
    break;

  case 11:      // Thorium Tetrafluoride (ThF4)
    numel = 2;
    cmpnd[0].z = 90; cmpnd[0].a = 232; cmpnd[0].w = cmpnd[0].a*1.0;
    cmpnd[1].z = 9; cmpnd[1].a = 19; cmpnd[1].w = cmpnd[1].a*4.0;
    break;

  case 12:      // Stainless Steel (316L)
    numel = 4;
    cmpnd[0].z = 24; cmpnd[0].a = 52; cmpnd[0].w = 51.9961*0.16;
    cmpnd[1].z = 28; cmpnd[1].a = 59; cmpnd[1].w = 58.6934*0.12;
    cmpnd[2].z = 42; cmpnd[2].a = 96; cmpnd[2].w = 95.94*0.02;
    cmpnd[3].z = 26; cmpnd[3].a = 56; cmpnd[3].w = 55.847*0.70;
    break;

  // Gases

  case 100:     // Carbon Tetrafluoride (CF4)
    numel = 2;
    cmpnd[0].z = 6; cmpnd[0].a = 12; cmpnd[0].w = cmpnd[0].a*1.0;
    cmpnd[1].z = 9; cmpnd[1].a = 19; cmpnd[1].w = cmpnd[1].a*4.0;
    break;

  case 101:     // Propane (H-8, C-3)
    numel = 2;
    cmpnd[0].z = 1; cmpnd[0].a = 1;  cmpnd[0].w = cmpnd[0].a*8.0;
    cmpnd[1].z = 6; cmpnd[1].a = 12; cmpnd[1].w = cmpnd[1].a*3.0;
    break;

  case 102:     // Butane (H-10, C-4)
    numel = 2;
    cmpnd[0].z = 1; cmpnd[0].a = 1;  cmpnd[0].w = cmpnd[0].a*10.0;
    cmpnd[1].z = 6; cmpnd[1].a = 12; cmpnd[1].w = cmpnd[1].a*4.0;
    break;
  case 103:     // Octane (H-18, C-8)
    numel = 2;
    cmpnd[0].z = 1; cmpnd[0].a = 1;  cmpnd[0].w = cmpnd[0].a*18.0;
    cmpnd[1].z = 6; cmpnd[1].a = 12; cmpnd[1].w = cmpnd[1].a*8.0;
    break;
  default:
    fprintf(stderr,"No valid absorber data.\n");
    exit(EXIT_FAILURE);
  }
}

/*
  Data pool for aluminium -dE/dx/Z2.
  Call with energy E/A and get a series of log(Z) and log((-dE/dx)/Z2)
*/
void alref(double le, double *lz, double *dedx) {

  double zval[22] = {1.,2.,3.,4.,5.,6.,7.,8.,9.,10.,11.,12.,13.,16.,
		     20.,25.,32.,40.,50.,61.,79.,100.};

  double elog[42] = {-1.903090,-1.795880,-1.698970,-1.602060,-1.494850,
		     -1.397940,-1.301030,-1.221849,-1.154902,-1.096910,
		     -1.045757,-1.000000,-0.903090,-0.795880,-0.698970,
		     -0.602060,-0.494850,-0.397940,-0.301030,-0.221849,
		     -0.154902,-0.096910,-0.045757, 0.000000,+0.096910,
		     +0.204120,+0.301030,+0.397940,+0.505150,+0.602060,
		     +0.698970,+0.778151,+0.845098,+0.903090,+0.954243,
		     +1.000000,+1.041393,+1.079181,+1.301030,+1.602060,
		     +1.845098,+2.000000};

  // H; Z=1
  double h[42] = {-0.67572,-0.62160,-0.57349,-0.52143,-0.46980,-0.43063,
		  -0.39794,-0.37779,-0.36653,-0.35952,-0.35655,-0.35655,
		  -0.36351,-0.38195,-0.40782,-0.44129,-0.48545,-0.53018,
		  -0.58004,-0.62709,-0.66555,-0.70115,-0.73049,-0.75945,
		  -0.82102,-0.88941,-0.95468,-1.02228,-1.10237,-1.17393,
		  -1.24413,-1.30103,-1.35655,-1.39794,-1.43180,-1.46852,
		  -1.49485,-1.52288,-1.72584,-1.95861,-2.14874,-2.25181};

  // He; Z=2
  double he[42] = {-0.87615,-0.82246,-0.77404,-0.72584,-0.67162,-0.62663,
		   -0.58503,-0.55479,-0.53276,-0.51606,-0.50376,-0.49485,
		   -0.48247,-0.48050,-0.48845,-0.50585,-0.53387,-0.56623,
		   -0.60380,-0.64589,-0.68194,-0.71388,-0.74232,-0.76828,
		   -0.82536,-0.89279,-0.95664,-1.02342,-1.09963,-1.17070,
		   -1.24222,-1.30103,-1.35164,-1.39523,-1.43474,-1.46852,
		   -1.49826,-1.53018,-1.70997,-1.94310,-2.13077,-2.23657};

  // Li; Z=3
  double li[42] = {-1.03990,-0.98623,-0.93763,-0.88904,-0.83532,-0.78870,
		   -0.74473,-0.71145,-0.68566,-0.66577,-0.65018,-0.63827,
		   -0.61939,-0.60985,-0.61103,-0.61979,-0.63618,-0.65561,
		   -0.67778,-0.70358,-0.72816,-0.75175,-0.77440,-0.79588,
		   -0.84568,-0.90658,-0.96658,-1.02996,-1.10360,-1.17249,
		   -1.24328,-1.30200,-1.35218,-1.39674,-1.43573,-1.47137,
		   -1.50246,-1.53264,-1.70333,-1.93554,-2.11919,-2.22915};

  // Be; Z=4
  double be[42] = {-1.16630,-1.11280,-1.06424,-1.01604,-0.96232,-0.91498,
		   -0.86967,-0.83472,-0.80740,-0.78615,-0.76955,-0.75696,
		   -0.73785,-0.72830,-0.72801,-0.73283,-0.74172,-0.75187,
		   -0.76321,-0.77875,-0.79385,-0.80879,-0.82373,-0.83863,
		   -0.87533,-0.92445,-0.97675,-1.03533,-1.10582,-1.17352,
		   -1.24365,-1.30266,-1.35347,-1.39794,-1.43771,-1.47334,
		   -1.50515,-1.53480,-1.70115,-1.92812,-2.11919,-2.22915};

  // B; Z=5
  double b[42] = {-1.26857,-1.21496,-1.16673,-1.11827,-1.06449,-1.01827,
		  -0.97469,-0.94157,-0.91578,-0.89551,-0.87943,-0.86646,
		  -0.84430,-0.82786,-0.81976,-0.81667,-0.81793,-0.82206,
		  -0.82822,-0.83791,-0.84783,-0.85811,-0.86864,-0.87943,
		  -0.90714,-0.94692,-0.99140,-1.04383,-1.10969,-1.17496,
		  -1.24413,-1.30277,-1.35379,-1.39881,-1.43890,-1.47470,
		  -1.50808,-1.53820,-1.69897,-1.92812,-2.11351,-2.22915};

  // C; Z=6
  double c[42] = {-1.36597,-1.31227,-1.26382,-1.21546,-1.16168,-1.11335,
		  -1.06803,-1.03230,-1.00327,-0.97939,-0.95960,-0.94310,
		  -0.91315,-0.88941,-0.87642,-0.86967,-0.86708,-0.86753,
		  -0.86967,-0.87751,-0.88587,-0.89477,-0.90406,-0.91364,
		  -0.93825,-0.97356,-1.01323,-1.06048,-1.12094,-1.18192,
		  -1.24795,-1.30491,-1.35491,-1.39915,-1.43903,-1.47496,
		  -1.50786,-1.53843,-1.69897,-1.92812,-2.10791,-2.23657};

  // N; Z=7
  double n[42] = {-1.43468,-1.38099,-1.33264,-1.28417,-1.23065,-1.18207,
		  -1.13789,-1.10316,-1.07498,-1.05171,-1.03209,-1.01543,
		  -0.98331,-0.95348,-0.93242,-0.91721,-0.90694,-0.90295,
		  -0.90309,-0.90873,-0.91546,-0.92289,-0.93091,-0.93930,
		  -0.96160,-0.99419,-1.03152,-1.07625,-1.13389,-1.19230,
		  -1.25579,-1.31053,-1.35877,-1.40150,-1.44002,-1.47509,
		  -1.50693,-1.53638,-1.69897,-1.92812,-2.11351,-2.23657};

  // O; Z=8
  double o[42] = {-1.51481,-1.46120,-1.41260,-1.36417,-1.31064,-1.26211,
		  -1.21679,-1.18066,-1.15095,-1.12594,-1.10461,-1.08619,
		  -1.04977,-1.01456,-0.98855,-0.96859,-0.95321,-0.94441,
		  -0.93930,-0.94119,-0.94554,-0.95157,-0.95873,-0.96658,
		  -0.98809,-1.01971,-1.05552,-1.09793,-1.15220,-1.20728,
		  -1.26761,-1.32032,-1.36701,-1.40876,-1.44672,-1.48149,
		  -1.51348,-1.54302,-1.70115,-1.92996,-2.11919,-2.23657};

  // F; Z=9
  double f[42] = {-1.59335,-1.53983,-1.49135,-1.44295,-1.38931,-1.34087,
		  -1.29243,-1.25489,-1.22382,-1.19744,-1.17473,-1.15490,
		  -1.11504,-1.07534,-1.04469,-1.02002,-0.99984,-0.98727,
		  -0.97881,-0.97881,-0.98183,-0.98680,-0.99298,-1.00000,
		  -1.01946,-1.04827,-1.08092,-1.11968,-1.16939,-1.22033,
		  -1.27653,-1.32619,-1.37067,-1.41086,-1.44759,-1.48149,
		  -1.51281,-1.54206,-1.70333,-1.93554,-2.11919,-2.23657};

  // Ne; Z=10
  double ne[42] = {-1.667562,-1.614036,-1.565431,-1.516984,-1.463442,
		   -1.414991,-1.366532,-1.327440,-1.294821,-1.267044,
		   -1.242984,-1.221849,-1.178814,-1.134837,-1.099851,
		   -1.070581,-1.045661,-1.029374,-1.017729,-1.016554,
		   -1.018544,-1.022505,-1.027751,-1.033858,-1.051294,
		   -1.077638,-1.107905,-1.144118,-1.190912,-1.239050,
		   -1.292430,-1.339704,-1.382161,-1.420559,-1.455684,
		   -1.488117,-1.518128,-1.546223,-1.709965,-1.939302,
		   -2.124939,-2.244125};

  // Na; Z=11
  double na[42] = {-1.721058,-1.667311,-1.618892,-1.570501,-1.516820,
		   -1.468416,-1.419933,-1.380786,-1.348226,-1.320407,
		   -1.296389,-1.275318,-1.232446,-1.188746,-1.153929,
		   -1.124556,-1.098528,-1.080058,-1.065126,-1.059368,
		   -1.057930,-1.059286,-1.062507,-1.067048,-1.081744,
		   -1.106069,-1.135107,-1.170563,-1.216675,-1.264098,
		   -1.316521,-1.362626,-1.403721,-1.440816,-1.474580,
		   -1.505523,-1.534028,-1.560602,-1.712198,-1.939302,
		   -2.130768,-2.244125};

  // Mg; Z=13
  double mg[42] = {-1.772578,-1.719030,-1.670517,-1.622183,-1.568525,
		   -1.520073,-1.471637,-1.432043,-1.398770,-1.370336,
		   -1.345650,-1.324005,-1.280013,-1.235689,-1.201234,
		   -1.172622,-1.146496,-1.126147,-1.107635,-1.098269,
		   -1.093830,-1.092708,-1.093905,-1.096722,-1.108137,
		   -1.129466,-1.156326,-1.189926,-1.234445,-1.280588,
		   -1.331705,-1.376751,-1.416896,-1.453012,-1.485895,
		   -1.515997,-1.543782,-1.569643,-1.716699,-1.943095,
		   -2.130768,-2.244125};

  // Al; Z=13
  double al[42] = {-1.819477,-1.765788,-1.717342,-1.668938,-1.615315,
		   -1.566832,-1.518362,-1.478769,-1.445056,-1.416178,
		   -1.391120,-1.368989,-1.324092,-1.279083,-1.244712,
		   -1.216274,-1.189346,-1.167302,-1.146395,-1.134325,
		   -1.127585,-1.124494,-1.123946,-1.125247,-1.133765,
		   -1.152303,-1.177082,-1.208978,-1.251858,-1.296734,
		   -1.346616,-1.390614,-1.429789,-1.465058,-1.497104,
		   -1.526405,-1.553485,-1.578552,-1.721246,-1.946922,
		   -2.130768,-2.251812};

  // S; Z=16
  double s[42] = {-1.940188,-1.886579,-1.838047,-1.789669,-1.736050,
		  -1.687585,-1.639158,-1.599556,-1.566068,-1.536375,
		  -1.510448,-1.487543,-1.440552,-1.393635,-1.358479,
		  -1.328625,-1.298392,-1.272186,-1.246453,-1.229580,
		  -1.218301,-1.211042,-1.206734,-1.204636,-1.206133,
		  -1.217544,-1.236718,-1.263853,-1.302185,-1.343333,
		  -1.389623,-1.430608,-1.467176,-1.500023,-1.529833,
		  -1.557043,-1.582165,-1.605329,-1.739929,-1.954677,
		  -2.142668,-2.251812};

  // Ca; Z=20
  double ca[42] = {-2.075979,-2.021819,-1.972854,-1.923997,-1.869827,
		   -1.820951,-1.771985,-1.732066,-1.698265,-1.668978,
		   -1.643162,-1.619608,-1.570934,-1.521578,-1.483795,
		   -1.450506,-1.415782,-1.385129,-1.354774,-1.334630,
		   -1.320095,-1.309649,-1.302291,-1.297333,-1.292494,
		   -1.296881,-1.310092,-1.331777,-1.364667,-1.401237,
		   -1.443065,-1.480402,-1.513818,-1.543900,-1.571217,
		   -1.596151,-1.619111,-1.640402,-1.761954,-1.968592,
		   -2.148742,-2.259637};

  // Mn; Z=25
  double mn[42] = {-2.225571,-2.170053,-2.119827,-2.069642,-2.014125,
		   -1.963946,-1.913754,-1.872740,-1.838033,-1.807990,
		   -1.781528,-1.757816,-1.707638,-1.655498,-1.613580,
		   -1.575563,-1.535642,-1.500335,-1.465385,-1.442445,
		   -1.425311,-1.412424,-1.402779,-1.395653,-1.385879,
		   -1.384429,-1.392159,-1.408383,-1.435381,-1.466787,
		   -1.503646,-1.537003,-1.567095,-1.594346,-1.619152,
		   -1.641882,-1.662852,-1.682271,-1.787812,-1.982967,
		   -2.161151,-2.267606};

  // Ge; Z=32
  double ge[42] = {-2.400492,-2.343408,-2.291715,-2.240111,-2.182995,
		   -2.131319,-2.079657,-2.037496,-2.001785,-1.970886,
		   -1.943639,-1.919231,-1.867598,-1.810463,-1.763088,
		   -1.718798,-1.672302,-1.631539,-1.591419,-1.564711,
		   -1.544545,-1.529158,-1.517344,-1.508296,-1.494333,
		   -1.487817,-1.490406,-1.500990,-1.521326,-1.546631,
		   -1.577491,-1.606185,-1.632484,-1.656595,-1.678751,
		   -1.699203,-1.718177,-1.735865,-1.823909,-2.002177,
		   -2.187087,-2.283997};

  // Zr; Z=40
  double zr[42] = {-2.561853,-2.503243,-2.450231,-2.397194,-2.338601,
		   -2.285565,-2.232566,-2.189264,-2.152620,-2.120904,
		   -2.092925,-2.067907,-2.014882,-1.956245,-1.903242,
		   -1.852826,-1.799560,-1.753563,-1.709214,-1.677858,
		   -1.654381,-1.636459,-1.622625,-1.611899,-1.594536,
		   -1.584078,-1.582591,-1.588464,-1.602995,-1.622728,
		   -1.648011,-1.672309,-1.695106,-1.716345,-1.736142,
		   -1.754611,-1.771888,-1.788112,-1.861697,-2.026872,
		   -2.200659,-2.301030};

  // Sn; Z=50
  double sn[42] = {-2.721064,-2.660906,-2.606460,-2.552036,-2.491821,
		   -2.437422,-2.383000,-2.338528,-2.300926,-2.268347,
		   -2.239608,-2.213930,-2.159492,-2.099283,-2.044871,
		   -1.990430,-1.930228,-1.878243,-1.830878,-1.794081,
		   -1.766699,-1.745819,-1.729629,-1.716934,-1.695613,
		   -1.680761,-1.675002,-1.676195,-1.685072,-1.699405,
		   -1.719194,-1.739042,-1.758185,-1.776379,-1.793595,
		   -1.809859,-1.825243,-1.839808,-1.913640,-2.060481,
		   -2.229148,-2.318759};

  // Pm; Z=61
  double pm[42] = {-2.859781,-2.798118,-2.742451,-2.686714,-2.625043,
		   -2.569315,-2.513602,-2.468054,-2.429555,-2.396193,
		   -2.366784,-2.340466,-2.284742,-2.223095,-2.167368,
		   -2.111644,-2.049993,-1.993513,-1.942557,-1.901296,
		   -1.870337,-1.846490,-1.827754,-1.812816,-1.786842,
		   -1.766889,-1.756499,-1.752995,-1.756612,-1.766145,
		   -1.781107,-1.797027,-1.812861,-1.828225,-1.842956,
		   -1.857026,-1.870441,-1.883229,-1.958607,-2.096910,
		   -2.259637,-2.337242};

  // Au; Z=79
  double au[42] = {-3.042131,-2.978549,-2.921062,-2.863644,-2.800058,
		   -2.742599,-2.685136,-2.638190,-2.598525,-2.564142,
		   -2.533801,-2.506670,-2.449214,-2.385659,-2.328194,
		   -2.270741,-2.207173,-2.149714,-2.092264,-2.047594,
		   -2.012868,-1.985183,-1.962713,-1.944210,-1.910215,
		   -1.881059,-1.862441,-1.851053,-1.846528,-1.849244,
		   -1.857867,-1.868886,-1.880736,-1.892718,-1.904509,
		   -1.915963,-1.927015,-1.937638,-2.017729,-2.154902,
		   -2.288193,-2.361511};

  // Fm; Z=100
  double fm[42] = {-3.208520,-3.143211,-3.084231,-3.025212,-2.959912,
		   -2.900872,-2.841879,-2.793633,-2.752862,-2.717559,
		   -2.686407,-2.658546,-2.599514,-2.534231,-2.475215,
		   -2.416189,-2.350899,-2.291885,-2.232866,-2.188767,
		   -2.152835,-2.122876,-2.097497,-2.075726,-2.033033,
		   -1.992295,-1.962577,-1.940611,-1.925985,-1.921442,
		   -1.924464,-1.931844,-1.941035,-1.950879,-1.960828,
		   -1.970612,-1.980107,-1.989259,-2.070581,-2.193820,
		   -2.309804,-2.371611};

  double err;
  unsigned int jj;

  for ( int j = 0; j < 22 ; j++ ) {
    *(lz+j) = log10(zval[j]);
  }

  jj = nr_locate(elog,42,le);
  if ( jj > 39 ) jj = 39;

  // Interpolate data for Al to given energy for all standard ions

  // Hydrogen ions
  *(dedx++) = nr_polint(&elog[jj],&h[jj],3,le,&err);

  // Helium ions
  *(dedx++) = nr_polint(&elog[jj],&he[jj],3,le,&err);

  // Lithium ions
  *(dedx++) = nr_polint(&elog[jj],&li[jj],3,le,&err);

  // Beryllium ions
  *(dedx++) = nr_polint(&elog[jj],&be[jj],3,le,&err);

  // Bor ions
  *(dedx++) = nr_polint(&elog[jj],&b[jj],3,le,&err);

  // Carbon ions
  *(dedx++) = nr_polint(&elog[jj],&c[jj],3,le,&err);

  // Nitrogen ions
  *(dedx++) = nr_polint(&elog[jj],&n[jj],3,le,&err);

  // Oxygen ions
  *(dedx++) = nr_polint(&elog[jj],&o[jj],3,le,&err);

  // Fluorine ions
  *(dedx++) = nr_polint(&elog[jj],&f[jj],3,le,&err);

  // Neon ions
  *(dedx++) = nr_polint(&elog[jj],&ne[jj],3,le,&err);

  // Sodium ions
  *(dedx++) = nr_polint(&elog[jj],&na[jj],3,le,&err);

  // Magnesium ions
  *(dedx++) = nr_polint(&elog[jj],&mg[jj],3,le,&err);

  // Aluminium ions
  *(dedx++) = nr_polint(&elog[jj],&al[jj],3,le,&err);

  // Sulfur ions
  *(dedx++) = nr_polint(&elog[jj],&s[jj],3,le,&err);

  // Calcium ions
  *(dedx++) = nr_polint(&elog[jj],&ca[jj],3,le,&err);

  // Manganese ions
  *(dedx++) = nr_polint(&elog[jj],&mn[jj],3,le,&err);

  // Germanium ions
  *(dedx++) = nr_polint(&elog[jj],&ge[jj],3,le,&err);

  // Zirconium ions
  *(dedx++) = nr_polint(&elog[jj],&zr[jj],3,le,&err);

  // Tin ions
  *(dedx++) = nr_polint(&elog[jj],&sn[jj],3,le,&err);

  // Prometium ions
  *(dedx++) = nr_polint(&elog[jj],&pm[jj],3,le,&err);

  // Gold ions
  *(dedx++) = nr_polint(&elog[jj],&au[jj],3,le,&err);

  // Fermium ions
  *(dedx++) = nr_polint(&elog[jj],&fm[jj],3,le,&err);
}

/*
  Get corresponding vectors of log(E/A) and log((dE/dx)/Z2) for a
  specific ion with charge Z in Aluminium
*/
void alion(int zp, double *dedxz2) {

  double elog[42] = {-1.903089986992,-1.795880017344,-1.698970004336,-1.602059991328,-1.494850021680,
                     -1.397940008672,-1.301029995664,-1.221848749616,-1.154901959986,-1.096910013008,
		     -1.045757490561,-1.000000000000,-0.903089986992,-0.795880017344,-0.698970004336,
		     -0.602059991328,-0.494850021680,-0.397940008672,-0.301029995664,-0.221848749616,
		     -0.154901959986,-0.096910013008,-0.045757490561,+0.000000000000,+0.096910013008,
		     +0.204119982656,+0.301029995664,+0.397940008672,+0.505149978320,+0.602059991328,
		     +0.698970004336,+0.778151250384,+0.845098040014,+0.903089986992,+0.954242509439,
		     +1.000000000000,+1.041392685158,+1.079181246048,+1.301029995664,+1.602059991328,
		     +1.845098040014,+2.000000000000};

  unsigned int jj;
  double dedx[22], lz[22];
  double zlog, err;

  zlog = log10(zp);

  for ( int j = 0; j < 42 ; j++ ) {
    alref(elog[j],&lz[0],&dedx[0]);
    jj = nr_locate(lz,22,zlog);
    if ( jj > 19 ) jj = 19;
    *(dedxz2+j) = nr_polint(&lz[jj],&dedx[jj],3,zlog,&err);
  }
}

/*
  Given E/A (MeV/A) and the gas material atomic number Z, A
  logarithm F is calculated that should be used to convert
  stopping power in Aluminium to stopping power of the gas
  with atomic number Z by adding it to the log of -(1/Z2)(dE/dx)
  This routine is for gases only.
*/
void gfact(double *le, int zt, double *f) {

  double za[9] = {1.0,2.0,7.0,8.0,10.0,18.0,36.0,54.0,86.0};

  double ea[38] = {0.0125,0.0160,0.0200,0.0250,0.0320,0.0400,
                   0.0500,0.0600,0.0700,0.0800,0.0900,0.1000,
		   0.1250,0.1600,0.2000,0.2500,0.3200,0.4000,
		   0.5000,0.6000,0.7000,0.8000,0.9000,1.0000,
		   1.2500,1.6000,2.0000,2.5000,3.2000,4.0000,
		   5.0000,6.0000,7.0000,8.0000,9.0000,10.000,
		   11.000,12.0000};

  double far[38] = {0.5840,0.5891,0.5950,0.6070,0.6251,0.6461,
                    0.6710,0.6970,0.7220,0.7470,0.7710,0.7950,
		    0.8510,0.9230,0.9850,1.0340,1.0550,1.0510,
		    1.0310,1.0010,0.9640,0.9280,0.8940,0.8710,
		    0.8430,0.8350,0.8420,0.8620,0.8850,0.9000,
		    0.9090,0.9140,0.9180,0.9190,0.9200,0.9200,
		    0.9200,0.9200};

  double fa[38][9] = {
    {6.4213,2.7396,1.8149,1.7055,1.5153,1.0,0.6132,0.4349,0.2868},
    {6.2480,2.6351,1.7709,1.6654,1.4804,1.0,0.6195,0.4415,0.2931},
    {6.0166,2.4705,1.7091,1.6102,1.4403,1.0,0.6235,0.4536,0.3036},
    {5.7334,2.2751,1.6345,1.5404,1.3939,1.0,0.6393,0.4661,0.3378},
    {5.4557,2.0702,1.5344,1.4608,1.3343,1.0,0.6495,0.4895,0.3408},
    {5.1854,1.8853,1.4441,1.3900,1.2800,1.0,0.6625,0.5078,0.3607},
    {4.9329,1.7348,1.3695,1.3323,1.2400,1.0,0.6736,0.5246,0.3800},
    {4.7917,1.6397,1.3299,1.2854,1.2152,1.0,0.6800,0.5351,0.3931},
    {4.6953,1.5900,1.3020,1.2645,1.1994,1.0,0.6815,0.5415,0.4003},
    {4.6454,1.5596,1.2866,1.2504,1.1901,1.0,0.6855,0.5462,0.4056},
    {4.6042,1.5446,1.2775,1.2451,1.1854,1.0,0.6873,0.5499,0.4072},
    {4.6038,1.5447,1.2805,1.2403,1.1799,1.0,0.6906,0.5497,0.4076},
    {4.6652,1.5571,1.2868,1.2397,1.1845,1.0,0.6886,0.5488,0.4078},
    {4.7995,1.6002,1.3131,1.2654,1.2004,1.0,0.6858,0.5460,0.4052},
    {4.9848,1.6548,1.3553,1.3015,1.2305,1.0,0.6802,0.5401,0.3990},
    {5.2418,1.7351,1.4072,1.3549,1.2650,1.0,0.6760,0.5300,0.3897},
    {5.6304,1.8379,1.4948,1.4265,1.3052,1.0,0.6673,0.5204,0.3801},
    {5.9373,1.9601,1.5566,1.4796,1.3397,1.0,0.6613,0.5148,0.3749},
    {6.1881,2.0563,1.5975,1.5199,1.3598,1.0,0.6595,0.5150,0.3754},
    {6.3436,2.1279,1.6104,1.5305,1.3676,1.0,0.6633,0.5175,0.3786},
    {6.3693,2.1888,1.6100,1.5301,1.3693,1.0,0.6691,0.5207,0.3848},
    {6.3254,2.2198,1.6045,1.5301,1.3674,1.0,0.6767,0.5280,0.3922},
    {6.2639,2.2326,1.5995,1.5246,1.3557,1.0,0.6823,0.5391,0.4005},
    {6.1883,2.2377,1.5970,1.5155,1.3502,1.0,0.6889,0.5488,0.4076},
    {5.8955,2.2076,1.5718,1.5006,1.3333,1.0,0.7022,0.5670,0.4282},
    {5.4133,2.1198,1.5306,1.4635,1.3102,1.0,0.7174,0.5832,0.4515},
    {4.9170,2.0155,1.4941,1.4228,1.2874,1.0,0.7304,0.5998,0.4715},
    {4.3851,1.8851,1.4397,1.3701,1.2645,1.0,0.7424,0.6183,0.4919},
    {3.9549,1.7571,1.3933,1.3299,1.2350,1.0,0.7605,0.6328,0.5073},
    {3.6667,1.6578,1.3555,1.3000,1.2222,1.0,0.7667,0.6456,0.5222},
    {3.4983,1.5896,1.3300,1.2805,1.2068,1.0,0.7778,0.6567,0.5390},
    {3.4027,1.5471,1.3151,1.2648,1.1980,1.0,0.7812,0.6641,0.5471},
    {3.3442,1.5185,1.3050,1.2582,1.1895,1.0,0.7865,0.6710,0.5545},
    {3.3080,1.4962,1.3003,1.2546,1.1850,1.0,0.7867,0.6746,0.5604},
    {3.2717,1.4870,1.2946,1.2500,1.1826,1.0,0.7881,0.6772,0.5652},
    {3.2500,1.4837,1.2946,1.2500,1.1826,1.0,0.7902,0.6793,0.5685},
    {3.2282,1.4804,1.2945,1.2500,1.1826,1.0,0.7924,0.6815,0.5707},
    {3.2066,1.4772,1.2946,1.2500,1.1826,1.0,0.7946,0.6837,0.5728}
  };

  unsigned int jj;
  static double lfa[38][9], y2a[38][9];
  static double *pfa[38], *py2a[38];
  static double lza[9], lea[38], lfar[38];
  double zl, fgl, fgal, err;

  if ( !isw3 ) {
    for ( int i = 0 ; i < 38 ; i++ ) {
      lea[i] = log10(ea[i]);
      lfar[i] = log10(far[i]);
      for ( int j = 0 ; j < 9 ; j++ ) {
	lfa[i][j] = log10(fa[i][j]);
      }
    }
    for ( int j = 0 ; j < 9 ; j++ ) {
      lza[j] = log10(za[j]);
    }
    for ( int i = 0 ; i < 38 ; i++ ) {
      pfa[i] = &(lfa[i])[0];
      py2a[i] = &(y2a[i])[0];
    }
    nr_splie2(lza,lea,&pfa[0],9,38,&py2a[0]);
    isw3 = true;
  }
  zl = log10(zt);
  if ( *le < lea[0] ) *le = lea[0];
  nr_splin2(lza,lea,&pfa[0],&py2a[0],9,38,zl,*le,&fgl);
  jj = nr_locate(lea,38,*le);
  if ( jj > 35 ) jj = 35;
  fgal = nr_polint(&lea[jj],&lfar[jj],3,*le,&err);
  *f = fgl + fgal;
}

/*
  Given E/A (MeV/A) and the material atomic number Z, A
  logarithm F is calculated that should be used to convert
  stopping power in Aluminium to stopping power of the material
  with atomic number Z by adding it to the log of -(1/Z2)(dE/dx)
  This routine is for solids only.
*/
void mpyers(double *le, int zt, double *f) {

  double za[12] = {4.0,6.0,13.0,22.0,28.0,32.0,40.0,47.0,63.0,73.0,79.0,92.0};

  double ea[38] = {0.0125,0.0160,0.0200,0.0250,0.0320,0.0400,
                   0.0500,0.0600,0.0700,0.0800,0.0900,0.1000,
		   0.1250,0.1600,0.2000,0.2500,0.3200,0.4000,
		   0.5000,0.6000,0.7000,0.8000,0.9000,1.0000,
		   1.2500,1.6000,2.0000,2.5000,3.2000,4.0000,
		   5.0000,6.0000,7.0000,8.0000,9.0000,10.000,
		   11.000,12.000};

  double fb[38][12] = {
    {1.6499,1.3651,1.0,0.6650,0.5395,0.4901,0.4540,0.4200,0.2669,0.2284,0.2100,0.1799},
    {1.6501,1.3652,1.0,0.6651,0.5400,0.4901,0.4541,0.4201,0.2671,0.2285,0.2099,0.1801},
    {1.6500,1.3650,1.0,0.6649,0.5400,0.4900,0.4540,0.4199,0.2670,0.2285,0.2101,0.1801},
    {1.6500,1.3650,1.0,0.6649,0.5401,0.4900,0.4541,0.4200,0.2669,0.2286,0.2105,0.1801},
    {1.6482,1.3662,1.0,0.6651,0.5410,0.4920,0.4540,0.4200,0.2670,0.2290,0.2111,0.1811},
    {1.6441,1.3691,1.0,0.6670,0.5440,0.4960,0.4570,0.4231,0.2690,0.2316,0.2129,0.1831},
    {1.6380,1.3729,1.0,0.6700,0.5490,0.4999,0.4610,0.4270,0.2710,0.2354,0.2170,0.1865},
    {1.6320,1.3810,1.0,0.6740,0.5540,0.5030,0.4650,0.4310,0.2760,0.2400,0.2215,0.1905},
    {1.6250,1.3901,1.0,0.6780,0.5600,0.5080,0.4700,0.4360,0.2800,0.2450,0.2270,0.1950},
    {1.6181,1.4021,1.0,0.6830,0.5650,0.5121,0.4730,0.4400,0.2850,0.2500,0.2310,0.1990},
    {1.6110,1.4140,1.0,0.6880,0.5700,0.5180,0.4770,0.4440,0.2910,0.2545,0.2360,0.2035},
    {1.6049,1.4270,1.0,0.6930,0.5760,0.5220,0.4800,0.4490,0.2960,0.2590,0.2400,0.2070},
    {1.5900,1.4670,1.0,0.7040,0.5880,0.5330,0.4900,0.4590,0.3075,0.2690,0.2515,0.2175},
    {1.5690,1.5251,1.0,0.7160,0.6020,0.5460,0.5010,0.4700,0.3200,0.2810,0.2635,0.2300},
    {1.5480,1.5710,1.0,0.7270,0.6150,0.5570,0.5110,0.4790,0.3320,0.2930,0.2750,0.2400},
    {1.5230,1.6021,1.0,0.7390,0.6280,0.5700,0.5220,0.4890,0.3450,0.3050,0.2860,0.2500},
    {1.4920,1.6210,1.0,0.7530,0.6430,0.5870,0.5350,0.5000,0.3580,0.3180,0.2985,0.2625},
    {1.4620,1.6230,1.0,0.7620,0.6560,0.6000,0.5470,0.5110,0.3720,0.3310,0.3110,0.2730},
    {1.4300,1.6070,1.0,0.7730,0.6700,0.6150,0.5600,0.5220,0.3860,0.3440,0.3235,0.2850},
    {1.4020,1.5790,1.0,0.7830,0.6820,0.6280,0.5700,0.5310,0.3970,0.3550,0.3345,0.2970},
    {1.3790,1.5480,1.0,0.7900,0.6910,0.6370,0.5770,0.5380,0.4060,0.3630,0.3430,0.3040},
    {1.3580,1.5140,1.0,0.7970,0.6990,0.6470,0.5850,0.5450,0.4140,0.3720,0.3510,0.3120},
    {1.3420,1.4830,1.0,0.8020,0.7070,0.6560,0.5920,0.5510,0.4230,0.3800,0.3590,0.3200},
    {1.3270,1.4530,1.0,0.8090,0.7140,0.6630,0.5990,0.5570,0.4300,0.3870,0.3660,0.3270},
    {1.2970,1.3890,1.0,0.8200,0.7300,0.6800,0.6130,0.5690,0.4470,0.4030,0.3810,0.3410},
    {1.2660,1.3270,1.0,0.8350,0.7460,0.6970,0.6280,0.5800,0.4650,0.4210,0.3980,0.3570},
    {1.2390,1.2930,1.0,0.8470,0.7610,0.7140,0.6400,0.5930,0.4800,0.4380,0.4140,0.3730},
    {1.2130,1.2710,1.0,0.8590,0.7770,0.7300,0.6530,0.6060,0.4980,0.4530,0.4300,0.3900},
    {1.1890,1.2560,1.0,0.8700,0.7920,0.7450,0.6680,0.6180,0.5160,0.4720,0.4480,0.4070},
    {1.1700,1.2460,1.0,0.8790,0.8050,0.7580,0.6830,0.6300,0.5330,0.4880,0.4650,0.4230},
    {1.1540,1.2370,1.0,0.8860,0.8160,0.7700,0.6940,0.6420,0.5500,0.5020,0.4810,0.4390},
    {1.1440,1.2300,1.0,0.8920,0.8230,0.7800,0.7040,0.6510,0.5580,0.5150,0.4930,0.4530},
    {1.1340,1.2250,1.0,0.8960,0.8280,0.7870,0.7120,0.6590,0.5700,0.5240,0.5030,0.4630},
    {1.1270,1.2200,1.0,0.9000,0.8330,0.7920,0.7200,0.6650,0.5780,0.5330,0.5120,0.4720},
    {1.1230,1.2150,1.0,0.9030,0.8370,0.7970,0.7250,0.6710,0.5850,0.5400,0.5190,0.4800},
    {1.1180,1.2100,1.0,0.9070,0.8400,0.8010,0.7290,0.6770,0.5900,0.5470,0.5270,0.4870},
    {1.1140,1.2070,1.0,0.9100,0.8440,0.8050,0.7330,0.6830,0.5960,0.5540,0.5350,0.4930},
    {1.1110,1.2030,1.0,0.9120,0.8470,0.8090,0.7370,0.6880,0.6010,0.5600,0.5400,0.4980}
  };

  static double lfb[38][12], y2b[38][12];
  static double *pfb[38], *py2b[38];
  static double lza[12], lea[38];
  double zl;

  if ( !isw4 ) {
    for ( int i = 0 ; i < 38 ; i++ ) {
      lea[i] = log10(ea[i]);
      for ( int j = 0 ; j < 12 ; j++ ) {
	lfb[i][j] = log10(fb[i][j]);
      }
    }
    for ( int j = 0 ; j < 12 ; j++ ) {
      lza[j] = log10(za[j]);
    }
    for ( int i = 0 ; i < 38 ; i++ ) {
      pfb[i] = &(lfb[i])[0];
      py2b[i] = &(y2b[i])[0];
    }
    nr_splie2(lza,lea,&pfb[0],12,38,&py2b[0]);
    isw4 = true;
  }

  zl = log10(zt);
  if ( *le < lea[0] ) *le = lea[0];
  nr_splin2(lza,lea,&pfb[0],&py2b[0],12,38,zl,*le,f);
}

/*
  Compute the "electrical" energy loss rate in any material
  (-dE/dx)/Z2.
*/
double ededx(double e, int zp, int zt) {

  double elog[42] = {-1.903089986992,-1.795880017344,-1.698970004336,-1.602059991328,-1.494850021680,
                     -1.397940008672,-1.301029995664,-1.221848749616,-1.154901959986,-1.096910013008,
		     -1.045757490561,-1.000000000000,-0.903089986992,-0.795880017344,-0.698970004336,
		     -0.602059991328,-0.494850021680,-0.397940008672,-0.301029995664,-0.221848749616,
		     -0.154901959986,-0.096910013008,-0.045757490561,+0.000000000000,+0.096910013008,
		     +0.204119982656,+0.301029995664,+0.397940008672,+0.505149978320,+0.602059991328,
		     +0.698970004336,+0.778151250384,+0.845098040014,+0.903089986992,+0.954242509439,
		     +1.000000000000,+1.041392685158,+1.079181246048,+1.301029995664,+1.602059991328,
		     +1.845098040014,+2.000000000000};

  int zgases[11] = {1,2,7,8,9,10,17,18,36,54,86};

  unsigned int jj;
  static double dedxz2[42];
  static double ak, a, ftargl;
  double b, ftarg, el, err;
  int gas;

  if ( !isw1 ) {
    alion(zp,&dedxz2[0]);
    ak = (dedxz2[2] - dedxz2[0]) / (elog[2] - elog[0]);
    a = dedxz2[0] - ak * elog[0];

    // Is it a gas?
    gas = 0;
    for ( int i = 0 ; i < 11 ; i++ ) {
      if ( zt == zgases[i] ) gas = 1;
    }

    // Special case for gases
    if ( gas ) {
      gfact(&elog[0],zt,&ftargl);
      dedxz2[0] += ftargl;
      for ( int j = 1 ; j < 42 ; j++ ) {
	gfact(&elog[j],zt,&ftarg);
	dedxz2[j] += ftarg;
      }
    }
    // It is a solid
    else {
      if ( zt != 13 ) {
	mpyers(&elog[0],zt,&ftargl);
	dedxz2[0] += ftargl;
	for ( int j = 1 ; j < 42 ; j++ ) {
	  mpyers(&elog[j],zt,&ftarg);
	  dedxz2[j] += ftarg;
	}
      }
    }
    isw1 = true;
  }
  el = log10(e);
  if ( el < elog[0] ) {
    b = a + ak * el + ftargl;
  }
  else {
    jj = nr_locate(elog,42,el);
    if ( jj > 39 ) jj = 39;
    b = nr_polint(&elog[jj],&dedxz2[jj],3,el,&err);
  }
  return pow(10.0,b);
}

/*
  Computes current value of nuclear stopping power for a
  projectile of energy e (MeV/A), mass ap and charge zp in an
  absorber with mass at and charge zt using a function fit to
  the LSS universal nuclear stopping power curve.
*/
double ndedx(double e, int zp, int ap, int zt, int at) {

  double zexpo, dedr;
  double x, y, xl, yl;

  // Compute current x-coordinate from projectile and target data
  zexpo = sqrt(pow(zp,2.0/3.0) + pow(zt,2.0/3.0));
  x = sqrt((e*ap*at/(ap+at)) / (zp*zt*zexpo));

  // Get log for polynomial fit
  xl = log10(x);
  yl = -6.80959 + xl * 
    (-6.60315 + xl * (-1.73474 + xl * xl * (0.04937 + xl * 0.00486)));
  y = pow(10.0,yl);

  // Convert y to -dEPS/dRHO
  dedr = y * zt * ap / (zp * at * (ap+at) * zexpo);
  return dedr;
}

/*
  Interpolate for current value of s(2,a) function as given by
  F.Hubert, R.Rimbot and H.Gauvin, Atomic Data and Nuclear Data
  Tables, 46, 1990.
*/
double s2az(double e, int zt) {

  double za[18] = {4.0,6.0,13.0,14.0,22.0,26.0,28.0,29.0,32.0,34.0,40.0,
		   47.0,50.0,64.0,73.0,79.0,82.0,92.0};

  double el[38] = {0.916290731874,1.098612288668,1.252762968495,1.386294361120,1.504077396776,1.609437912434,
                   1.704748092238,1.791759469228,1.871802176902,1.945910149055,2.079441541680,2.197224577336,
		   2.302585092994,2.397895272798,2.484906649788,2.708050201102,2.995732273554,3.218875824868,
		   3.401197381662,3.555348061489,3.688879454114,3.806662489770,3.912023005428,4.007333185232,
		   4.094344562222,4.174387269896,4.248495242049,4.382026634674,4.499809670330,4.605170185988,
		   5.010635294096,5.298317366548,5.521460917862,5.703782474656,5.857933154483,5.991464547108,
		   6.109247582764,6.214608098422};

  double sa2[18][38] = {
    {2.19060,2.32662,2.44357,2.54625,2.63806,2.72038,2.79565,2.86470,2.92901,
     2.98826,3.09555,3.19114,3.27677,3.35455,3.42575,3.60822,3.84436,4.02575,
     4.17501,4.29953,4.40693,4.50104,4.58488,4.66015,4.72819,4.79060,4.84820,
     4.95048,5.04019,5.11892,5.41429,5.61371,5.75009,5.85432,5.93698,6.00455,
     6.06082,6.10800},
    {2.12549,2.25929,2.37462,2.47575,2.56623,2.64754,2.72190,2.79035,2.85337,
     2.91231,3.01849,3.11283,3.19785,3.27479,3.34529,3.52676,3.76038,3.94119,
     4.08936,4.21313,4.31999,4.41372,4.49699,4.57174,4.63976,4.70168,4.75890,
     4.86103,4.94978,5.02829,5.32210,5.51089,5.64575,5.75009,5.83275,5.89980,
     5.95610,6.00253},
    {2.35942,2.48561,2.59461,2.69082,2.77700,2.85467,2.92574,2.99124,3.05177,
     3.10834,3.21078,3.30158,3.38360,3.45777,3.52591,3.70095,3.92841,4.10440,
     4.24925,4.37010,4.47392,4.56547,4.64677,4.72002,4.78639,4.84724,4.90290,
     5.00267,5.09008,5.16685,5.45439,5.64292,5.77635,5.87814,5.95900,6.02606,
     6.08139,6.12728},
    {2.33666,2.46187,2.57047,2.66607,2.75161,2.82895,2.89951,2.96472,3.02516,
     3.08129,3.18327,3.27346,3.35527,3.42883,3.49661,3.67202,3.89837,4.07454,
     4.21821,4.33897,4.44241,4.53378,4.61522,4.68828,4.75454,4.81527,4.87109,
     4.97081,5.05812,5.13492,5.42275,5.61783,5.75324,5.85519,5.93603,6.00152,
     6.05654,6.10240},
    {2.52604,2.64649,2.75161,2.84387,2.92667,3.00175,3.07046,3.13385,3.19236,
     3.24740,3.34671,3.43501,3.51409,3.58723,3.65351,3.82470,4.04698,4.21991,
     4.36027,4.47854,4.58194,4.67184,4.75222,4.82426,4.88952,4.94942,5.00490,
     5.10316,5.18946,5.26537,5.54999,5.73837,5.87013,5.97166,6.05122,6.11703,
     6.17179,6.21711},
    {2.58296,2.70008,2.80222,2.89273,2.97348,3.04703,3.11452,3.17666,3.23399,
     3.28809,3.38582,3.47216,3.55086,3.62216,3.68788,3.85730,4.07601,4.24750,
     4.38805,4.50533,4.60667,4.69592,4.77537,4.84692,4.91204,4.97154,5.02600,
     5.12394,5.20939,5.28491,5.56816,5.75324,5.88351,5.98449,6.06404,6.12958,
     6.18384,6.22972},
    {2.59931,2.71394,2.81383,2.90270,2.98232,3.05442,3.12073,3.18206,3.23844,
     3.29145,3.38803,3.47377,3.55173,3.62216,3.68688,3.85493,4.07307,4.24227,
     4.38203,4.49856,4.60018,4.68910,4.76828,4.83931,4.90425,4.96328,5.01804,
     5.11558,5.20028,5.27557,5.55709,5.74071,5.87102,5.97166,6.05122,6.11590,
     6.17059,6.21586},
    {2.65962,2.77379,2.87307,2.96133,3.04073,3.11227,3.17845,3.23972,3.29616,
     3.34884,3.44515,3.53102,3.60822,3.67794,3.74334,3.91077,4.12738,4.29769,
     4.43543,4.55400,4.65384,4.74271,4.82177,4.89285,4.95721,5.01653,5.07078,
     5.16817,5.25334,5.32826,5.60961,5.79425,5.92474,6.02399,6.10351,6.16820,
     6.22214,6.26722},
    {2.71018,2.82304,2.92155,3.00932,3.08785,3.15943,3.22515,3.28542,3.34175,
     3.39397,3.49003,3.57466,3.65158,3.72140,3.78649,3.95285,4.16853,4.33897,
     4.47634,4.59275,4.69373,4.78221,4.86103,4.93194,4.99636,5.05537,5.10977,
     5.20665,5.29134,5.36660,5.64717,5.80914,5.93982,6.03961,6.12044,6.18505,
     6.23993,6.28584},
    {2.75436,
     2.86558,2.96278,3.04913,3.12641,3.19724,3.26231,3.32216,3.37773,3.42960,
     3.52421,3.60914,3.68489,3.75502,3.81899,3.98459,4.19971,4.36812,4.50533,
     4.62283,4.72283,4.81097,4.88986,4.96042,5.02486,5.08401,5.13790,5.23534,
     5.32005,5.39483,5.67520,5.84305,5.97264,6.07268,6.15281,6.21837,6.27118,
     6.31720},
    {2.77780,2.88822,2.98479,3.07046,3.14714,3.21763,3.28208,3.34104,3.39621,
     3.44750,3.54132,3.62497,3.70095,3.77009,3.83275,3.99676,4.20976,4.37605,
     4.51442,4.62793,4.72819,4.81558,4.89352,4.96363,5.02753,5.08603,5.14003,
     5.23628,5.32056,5.39483,5.67374,5.85956,5.98847,6.08798,6.16582,6.23099,
     6.28449,6.32974},
    {2.86734,2.97446,3.06884,3.15239,3.22766,3.29616,3.35886,3.41733,3.47135,
     3.52167,3.61377,3.69590,3.77009,3.83854,3.90084,4.06139,4.27228,4.43543,
     4.57077,4.68313,4.78161,4.86783,4.94485,5.01389,5.07678,5.13450,5.18767,
     5.28244,5.36553,5.43873,5.71383,5.89797,6.02502,6.12385,6.20219,6.26590,
     6.31858,6.36398},
    {2.92667,3.03240,3.12527,3.20769,3.28208,3.34955,3.41201,3.46974,3.52337,
     3.57288,3.66419,3.74651,3.82013,3.88733,3.94895,4.10895,4.31811,4.48141,
     4.61522,4.72847,4.82644,4.91238,4.98900,5.05812,5.12101,5.17876,5.23159,
     5.32620,5.40925,5.48284,5.75718,5.94077,6.06835,6.16701,6.24507,6.30892,
     6.36253,6.40698},
    {3.03812,3.14018,3.22956,3.30907,3.38140,3.44672,3.50739,3.56313,3.61563,
     3.66419,3.75289,3.83275,3.90455,3.97124,4.03137,4.18827,4.39369,4.55448,
     4.68638,4.79815,4.89485,4.97986,5.05537,5.12394,5.18588,5.24288,5.29532,
     5.38934,5.47089,5.54358,5.81583,6.00051,6.12958,6.22719,6.30481,6.36834,
     6.42071,6.46467},
    {3.15063,3.24612,3.32981,3.40521,3.47377,3.53702,3.59448,3.64870,3.69893,
     3.74545,3.83160,3.90828,3.97790,4.04270,4.10137,4.25416,4.45524,4.61295,
     4.74271,4.85235,4.94766,5.03135,5.10605,5.17345,5.23487,5.29134,5.34279,
     5.43586,5.51710,5.58867,5.85781,6.04066,6.17299,6.26986,6.34671,6.40850,
     6.46147,6.50563},
    {3.21016,3.30294,3.38508,3.45856,3.52591,3.58723,3.64391,3.69590,3.74545,
     3.79091,3.87521,3.95154,4.02017,4.08341,4.14144,4.29182,4.49006,4.64573,
     4.77389,4.88257,4.97660,5.05969,5.13365,5.20028,5.26150,5.31699,5.36820,
     5.46025,5.54103,5.61234,5.88082,6.06189,6.19358,6.28987,6.36543,6.42842,
     6.47923,6.52420},
    {3.21763,3.31113,3.39323,3.46734,3.53530,3.59630,3.65351,3.70603,3.75609,
     3.80205,3.88733,3.96332,4.03137,4.09535,4.15250,4.30451,4.50329,4.65963,
     4.78819,4.89720,4.99157,5.07477,5.14904,5.21582,5.27656,5.33239,5.38388,
     5.47625,5.55644,5.62821,5.89615,6.07811,6.20962,6.30481,6.38155,6.44402,
     6.49565,6.53965},
    {3.26035,3.35455,3.43812,3.51325,3.58092,3.64391,3.70095,3.75395,3.80429,
     3.85022,3.93478,4.01184,4.08044,4.14459,4.20304,4.35363,4.55234,4.70859,
     4.83679,4.94555,5.03942,5.12227,5.19666,5.26343,5.32415,5.37953,5.43071,
     5.52271,5.60349,5.67447,5.94172,6.12044,6.24507,6.34102,6.41611,6.47923,
     6.53103,6.57307}
  };

  static double y2a[18][38];
  static double *psa2[18], *py2a[18];
  double sa2ln;
  double le;

  if ( !isw5 ) {
    for ( int i = 0 ; i < 18 ; i++ ) {
      psa2[i] = &(sa2[i])[0];
      py2a[i] = &(y2a[i])[0];
    }
    nr_splie2(el,za,&psa2[0],38,18,&py2a[0]);
    isw5 = true;
  }
  le = log(e);
  nr_splin2(el,za,&psa2[0],&py2a[0],38,18,le,zt,&sa2ln);
  return exp(-sa2ln);
}

/*
  Compute the "electrical" energy loss rate in any material
  (-dE/dx) above 2.5 MeV/A according to Hubert et al.
*/
double ededxh(double ea, int zp, int zt) {

  static double b, c, d;
  static double x1, x2, x3, x4;
  double xg1;

  // Special case for He
  if ( zp == 2 ) {
    isw2 = true;
    return s2az(ea,zt)*4.0;
  }

  if ( !isw2 ) {
    if ( zt == 4 ) {
      b = 2.000;
      c = 0.04369;
      d = 2.045;
      x2 = 7.000;
      x3 = 0.2643;
      x4 = 0.4171;
    }
    else if ( zt == 6 ) {
      b = 1.910;
      c = 0.03958;
      d = 2.584;
      x2 = 6.933;
      x3 = 0.2433;
      x4 = 0.3969;
    }
    else {
      b = 1.658;
      c = 0.0517;
      d = 1.164 + 0.2319 * exp(-0.004302*zt);
      x2 = 8.144 + 0.09876 * log(zt);
      x3 = 0.314 + 0.01072 * log(zt);
      x4 = 0.5218 + 0.02521 * log(zt);
    }
    x1 = d + b * exp(-c*zp);
    isw2 = true;
  }
  xg1 = 1.0 - x1 * exp(-x2*pow(ea,x3)/pow(zp,x4));
  return s2az(ea,zt)*pow((xg1*zp),2);
}

/*
  Compute 1/(dE/dx) for a given energy E/A and projectile and target.
*/
double dedx(int icorr, double ea, int zp, int ap, int zt, int at) {

  double dedxn, dedxe;

  if ( ea < 2.5 ) icorr = 0;
  switch(icorr) {
  case 0:
    dedxn = ndedx(ea,zp,ap,zt,at);
    dedxe = ededx(ea,zp,zt);
    return (dedxn + dedxe)*pow(zp,2);
    break;
  case 1:
    return ededxh(ea,zp,zt);
    break;
  default:
    fprintf(stderr,"No valid range correlation.\n");
    exit(EXIT_FAILURE);
  }
}

/*
  Calculates a range table given projectile and absorber. Tables are
  saved in stack to speed up calculations. Up to NSAV such tables 
  are saved.
*/
void rangetab(int icorr, int zp, int ap, int iabso, int zt, int at,
	      double *em, double *r, int *n){

  double elog[62] = {
    -2.0000000000,-1.9030899870,-1.7958800173,-1.6989700043,-1.6020599913,
    -1.4948500217,-1.3979400087,-1.3010299957,-1.2218487496,-1.1549019600,
    -1.0969100130,-1.0457574906,-1.0000000000,-0.9030899870,-0.7958800173,
    -0.6989700043,-0.6020599913,-0.4948500217,-0.3979400087,-0.3010299957,
    -0.2218487496,-0.1549019600,-0.0969100130,-0.0457574906, 0.0000000000,
     0.0969100130, 0.2041199827, 0.3010299957, 0.3979400087, 0.5051499783,
     0.6020599913, 0.6989700043, 0.7781512504, 0.8450980400, 0.9030899870,
     0.9542425094, 1.0000000000, 1.0413926852, 1.0791812460, 1.1760912591,
     1.3010299957, 1.3979400087, 1.4771212547, 1.5440680444, 1.6020599913,
     1.6532125138, 1.6989700043, 1.7781512504, 1.8450980400, 1.9030899870,
     1.9542425094, 2.0000000000, 2.0413926852, 2.0791812460, 2.1760912591,
     2.3010299957, 2.3979400087, 2.4771212547, 2.5440680444, 2.6020599913,
     2.6532125138, 2.6989700043};

  const double fmt = 0.005;
  int ntalel;
  double wtot;

  double est, elg, e;
  double rng, rval, rnow, rold;
  double etot, eold;
  double dedxnow;

  int k;
  int jsav;
  static int isav = 0;
  static int icc[NSAV], ijj[NSAV], iab[NSAV];
  static int izp[NSAV], iap[NSAV], izt[NSAV], iat[NSAV];
  static double esav[NSAV][NMAX], rsav[NSAV][NMAX];

  // Check if table saved
  if ( isav > 0 ) {
    for ( int i = 0 ; i < isav ; i++ ) {
      jsav = 0;
      if ( icorr == icc[i] ) jsav++;
      if ( iabso == iab[i] ) jsav++;
      if ( zp == izp[i] ) jsav++;
      if ( ap == iap[i] ) jsav++;
      if ( zt == izt[i] ) jsav++;
      if ( at == iat[i] ) jsav++;
      if ( jsav == 6 ) {
	k = ijj[i];
	for ( int j = 0 ; j < k ; j++ ) {
	  *(em+j) = esav[i][j];
	  *(r+j) = rsav[i][j];
	}
	*n = k;
	return;
      }
    }
  }

  if ( isav > NSAV ) {
    fprintf(stderr,"WARNING in rangetab: NSAV is too small\n");
    exit(EXIT_FAILURE);
  }
  // Save this call
  icc[isav] = icorr;
  iab[isav] = iabso;
  izp[isav] = zp;
  iap[isav] = ap;
  izt[isav] = zt;
  iat[isav] = at;

  switch(icorr) {
  case 0:
    ntalel = 38;
    break;
  case 1:
    ntalel = 61;
    break;
  default:
    fprintf(stderr,"No valid range correlation.\n");
    exit(EXIT_FAILURE);
  }

  // allocate matrix
  double **dedxt = malloc(NELMAX*sizeof(double *));
  for ( int i = 0 ; i < NELMAX ; i++ ) {
    dedxt[i] = malloc(NMAX*sizeof(double));
  }

  // define absorber
  def_absorber(zt,at,iabso);

  // Compute a range table
  est = 0.9 * elog[0];
  wtot = 0.0;
  for ( int i = 0 ; i < numel ; i++ ) {
    isw1 = false;
    isw2 = false;
    zt = cmpnd[i].z;
    at = cmpnd[i].a;
    wtot += cmpnd[i].w;
    *n = 0;
    for ( int j = 1 ; j <= 7000 ; j++ ) {
      elg = fmt * (double)(j-1200);
      e = pow(exp(elg),log(10.0));
      if ( elg >= est ) {
	if ( elg <= elog[ntalel] ) {
	  dedxt[i][*n] = dedx(icorr,e,zp,ap,zt,at);
	  *(em+(*n)) = elg;
	  (*n)++;
	}
	else {
	  break;
	}
	if ( *n > 3999 ) break;
      }
    }
  }

  ijj[isav] = *n;

  rng = 0.0;
  rold = 0.0;
  eold = 0.0;
  for ( int j = 0 ; j < *n ; j++ ) {
    elg = *(em+j);
    e = pow(exp(elg),log(10.0));
    etot = e * ap;
    dedxnow = 0.0;
    for ( int i = 0 ; i < numel ; i++ ) {
      dedxnow += dedxt[i][j] * cmpnd[i].w;
    }
    dedxnow /= wtot;
    rnow = 1.0 / dedxnow;
    rval = 0.5 * (rold + rnow) * (etot - eold);
    rng += rval;
    *(r+j) = rng;
    eold = etot;
    rold = rnow;
    esav[isav][j] = *(em+j);
    rsav[isav][j] = *(r+j);
  }
  isav++;

  // free allocated memory
  for ( int i = 0 ; i < NELMAX ; i++ ) {
    free(dedxt[i]);
  }
  free(dedxt);

}

/*
  Calculates a table of -dE/dx values given a projectile and
  absorber.
*/
void dedxtab(int icorr, int zp, int ap, int iabso, int zt, int at,
	     double e, double *tdedxe, double *tdedxn){

  double dedxn[NELMAX], dedxe[NELMAX];
  double tw;

  def_absorber(zt,at,iabso);

  for ( int i = 0 ; i < numel ; i++ ) {
    isw1 = false;
    isw2 = false;
    zt = cmpnd[i].z;
    at = cmpnd[i].a;
    if ( e < 2.5 ) {
      dedxn[i] = ndedx(e,zp,ap,zt,at)*pow(zp,2);
      dedxe[i] = ededx(e,zp,zt)*pow(zp,2);
    }
    else {
      if ( icorr == 1 ) {
	dedxn[i] = 0.0;
	dedxe[i] = ededxh(e,zp,zt);
      }
      else {
	dedxn[i] = ndedx(e,zp,ap,zt,at)*pow(zp,2);
	dedxe[i] = ededx(e,zp,zt)*pow(zp,2);
      }
    }
  }
  *tdedxn = *tdedxe = 0.0;
  tw = 0.0;
  for ( int i = 0 ; i < numel ; i++ ) {
    *tdedxn += dedxn[i] * cmpnd[i].w;
    *tdedxe += dedxe[i] * cmpnd[i].w;
    tw += cmpnd[i].w;
  }
  *tdedxn /= tw;
  *tdedxe /= tw;
}

#ifdef __cplusplus
}
#endif
